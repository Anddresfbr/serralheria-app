<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Serralheria Bom Preço - Gerenciador</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }
        .card-hover:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .modal {
            display: none; position: fixed; z-index: 1000; left: 0; top: 0;
            width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6);
            align-items: center; justify-content: center; padding: 1rem;
        }
        .modal-content {
            background-color: #1f2937; color: #e5e7eb; margin: auto; padding: 25px;
            border: 1px solid #374151; width: 90%; max-width: 600px;
            border-radius: 0.75rem; box-shadow: 0 10px 25px rgba(0,0,0,0.3);
        }
        .modal-header {
            padding-bottom: 1rem; border-bottom: 1px solid #374151; margin-bottom: 1.5rem;
            font-size: 1.25rem; font-weight: 600; color: #60a5fa;
        }
        .modal-footer {
            padding-top: 1rem; border-top: 1px solid #374151; margin-top: 1.5rem;
        }
        .logo-container { display: flex; flex-direction: column; align-items: center; margin-bottom: 1.5rem; }
        .logo-container img { max-width: 150px; margin-bottom: 0.75rem; border-radius: 0.5rem; background-color: white; padding: 5px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .orcamento-total-item { display: flex; justify-content: space-between; align-items: center; padding: 0.5rem 0; border-bottom: 1px solid #e5e7eb; }
        .orcamento-total-item:last-child { border-bottom: none; }
        .orcamento-total-label { font-weight: 500; color: #4b5563; }
        .orcamento-total-value { font-weight: 600; color: #1f2937; }
        .orcamento-total-geral .orcamento-total-label,
        .orcamento-total-geral .orcamento-total-value { font-size: 1.25rem; font-weight: 700; color: #166534; }
        .input-currency, .input-percent { width: 80px; padding: 0.25rem 0.5rem; border: 1px solid #d1d5db; border-radius: 0.375rem; text-align: right; }
        .input-percent:disabled { background-color: #e5e7eb; cursor: not-allowed; }

        @media print {
            body { background-color: #fff; }
            body > *:not(#printableArea) { display: none !important; }
            #printableArea { visibility: visible !important; display: block !important; position: absolute; left: 0; top: 0; width: 100%; font-size: 12px; color: #000 !important; }
            #printableArea h1, #printableArea h2, #printableArea h3, #printableArea h4 { color: #000 !important; }
            #printableArea .print-header img { max-width: 100px; margin-bottom: 10px; }
            #printableArea table { width: 100%; border-collapse: collapse; margin-bottom: 15px; }
            #printableArea th, #printableArea td { border: 1px solid #ccc; padding: 6px; text-align: left; }
            #printableArea th { background-color: #f0f0f0; }
            #printableArea .print-summary-item { display: flex; justify-content: space-between; padding: 4px 0; font-size: 13px; }
            #printableArea .print-summary-item.total { font-weight: bold; font-size: 14px; border-top: 1px solid #000; padding-top: 8px; margin-top: 8px; }
            .no-print { display: none !important; }
        }
        #printableArea { display: none; }
    </style>
</head>
<body class="flex flex-col items-center min-h-screen">

    <div id="login-screen" class="bg-white shadow-2xl rounded-xl p-10 w-full max-w-md text-center">
        <div class="logo-container">
            <img src="" alt="Logo da Empresa" id="loginLogo" class="max-w-[150px] mb-3 rounded-md bg-white p-1 shadow-sm">
            <h1 id="loginCompanyName" class="text-3xl font-bold text-gray-800">Carregando...</h1>
        </div>
        <p class="text-gray-600 mb-8">Bem-vindo ao Gerenciador de Orçamentos.</p>
        <button id="google-login-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-lg transition flex items-center justify-center space-x-3">
            <svg class="w-6 h-6" viewBox="0 0 48 48"><path fill="#FFC107" d="M43.611 20.083H42V20H24v8h11.303c-1.649 4.657-6.08 8-11.303 8c-6.627 0-12-5.373-12-12s5.373-12 12-12c3.059 0 5.842 1.154 7.961 3.039l5.657-5.657C34.046 6.053 29.268 4 24 4C12.955 4 4 12.955 4 24s8.955 20 20 20s20-8.955 20-20c0-1.341-.138-2.65-.389-3.917z"></path><path fill="#FF3D00" d="M6.306 14.691l6.571 4.819C14.655 15.108 18.961 12 24 12c3.059 0 5.842 1.154 7.961 3.039l5.657-5.657C34.046 6.053 29.268 4 24 4C16.318 4 9.656 8.337 6.306 14.691z"></path><path fill="#4CAF50" d="M24 44c5.166 0 9.86-1.977 13.409-5.192l-6.19-5.238C29.211 35.091 26.715 36 24 36c-5.202 0-9.619-3.317-11.283-7.946l-6.522 5.025C9.505 39.556 16.227 44 24 44z"></path><path fill="#1976D2" d="M43.611 20.083H42V20H24v8h11.303c-.792 2.237-2.231 4.166-4.087 5.571l6.19 5.238C42.012 36.49 44 30.686 44 24c0-1.341-.138-2.65-.389-3.917z"></path></svg>
            <span>Entrar com Google</span>
        </button>
        <p id="loginFeedback" class="mt-4 text-sm text-red-600"></p>
    </div>

    <div id="home-screen" class="w-full max-w-4xl mx-auto" style="display: none;">
         </div>

    <div id="main-app-content" class="w-full" style="display: none;">
        <div class="bg-white shadow-2xl rounded-xl p-6 md:p-10 w-full max-w-4xl text-slate-800 no-print mx-auto">
             <header class="mb-8 text-center relative">
                 <button id="btn-back-to-home" title="Voltar ao Início" class="absolute top-0 left-0 bg-slate-200 hover:bg-slate-300 p-2 rounded-full transition-colors">
                     <svg class="w-6 h-6 text-slate-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M10 19l-7-7m0 0l7-7m-7 7h18" /></svg>
                 </button>
                 <div class="logo-container">
                     <img src="" alt="Logo da Empresa" id="companyLogo">
                     <h1 id="mainCompanyName" class="text-3xl md:text-4xl font-bold text-sky-600"></h1>
                 </div>
                 <p class="text-slate-600 mt-2">Gerenciador de Orçamentos</p>
                 <div class="mt-4 text-xs text-slate-500">
                     <p>Usuário: <span id="userEmailDisplay" class="font-mono text-slate-700"></span></p>
                 </div>
             </header>
            
             <section id="saved-budgets-section" class="app-section" style="display: none;">
                <h2 class="text-2xl font-semibold text-gray-800 mb-4 text-center">Pedidos</h2>
                <div class="border-b border-gray-200">
                    <nav class="-mb-px flex space-x-6" aria-label="Tabs">
                        <button id="tab-todos" class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">
                            Todos os pedidos
                        </button>
                        <button id="tab-status" class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">
                            Pedidos por status
                        </button>
                    </nav>
                </div>
                <div class="my-4 flex gap-2">
                    <div class="relative flex-grow">
                        <div class="pointer-events-none absolute inset-y-0 left-0 flex items-center pl-3">
                            <svg class="h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 3.5a5.5 5.5 0 100 11 5.5 5.5 0 000-11zM2 9a7 7 0 1112.452 4.391l3.328 3.329a.75.75 0 11-1.06 1.06l-3.329-3.328A7 7 0 012 9z" clip-rule="evenodd" /></svg>
                        </div>
                        <input type="text" id="searchSavedBudgets" class="block w-full rounded-md border-0 bg-white py-2 pl-10 text-gray-900 ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-indigo-600 sm:text-sm" placeholder="Buscar por cliente...">
                    </div>
                </div>
                
                 <div id="savedBudgetsList" class="space-y-3"></div>
                 <div id="savedBudgetsGroupedList" class="space-y-6" style="display: none;"></div>
                
                 <p id="loadingSavedBudgetsMessage" class="text-slate-500 text-center">Carregando...</p>
                 <p id="noSavedBudgetsMessage" class="text-slate-500 text-center p-6" style="display: none;">Nenhum orçamento encontrado.</p>

                 <button id="fab-novo-orcamento" title="Criar Novo Orçamento" class="fixed z-90 bottom-8 right-8 bg-indigo-600 w-14 h-14 rounded-full drop-shadow-lg flex justify-center items-center text-white text-3xl hover:bg-indigo-700">
                     <svg xmlns="http://www.w3.org/2000/svg" class="w-7 h-7" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" /></svg>
                 </button>
             </section>
             
             </div>
    </div>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, deleteDoc, updateDoc, setDoc, getDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // ... (todo o seu código JS original, com as funções abaixo adicionadas ou modificadas)
        
        // Adicione esta variável no topo do seu script, com as outras
        let currentBudgetsView = 'all'; // 'all' ou 'byStatus'

        // Modifique sua função setupNavigation para incluir os listeners das abas
        function setupNavigation() {
            // ... (seus listeners originais) ...

            const tabTodos = document.getElementById('tab-todos');
            const tabStatus = document.getElementById('tab-status');
            
            if(tabTodos) tabTodos.addEventListener('click', () => switchBudgetsView('all'));
            if(tabStatus) tabStatus.addEventListener('click', () => switchBudgetsView('byStatus'));
        }

        // Adicione esta nova função ao seu script
        function switchBudgetsView(view) {
            currentBudgetsView = view;
            
            const tabTodos = document.getElementById('tab-todos');
            const tabStatus = document.getElementById('tab-status');
            const listContainer = document.getElementById('savedBudgetsList');
            const groupedListContainer = document.getElementById('savedBudgetsGroupedList');
            const searchInput = document.getElementById('searchSavedBudgets');

            if(!tabTodos || !tabStatus || !listContainer || !groupedListContainer) return;

            const activeClasses = 'text-indigo-600 border-indigo-500';
            const inactiveClasses = 'text-gray-500 border-transparent hover:text-gray-700 hover:border-gray-300';
            
            tabTodos.className = `whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm ${view === 'all' ? activeClasses : inactiveClasses}`;
            tabStatus.className = `whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm ${view === 'byStatus' ? activeClasses : inactiveClasses}`;
            
            searchInput.value = '';

            if (view === 'all') {
                listContainer.style.display = 'block';
                groupedListContainer.style.display = 'none';
                renderSavedBudgets(allSavedBudgets);
            } else {
                listContainer.style.display = 'none';
                groupedListContainer.style.display = 'block';
                renderGroupedBudgets();
            }
        }

        // Substitua sua função getStatusInfo por esta
        function getStatusInfo(status) {
            const statusLower = status?.toLowerCase() || 'pendente';
            switch (statusLower) {
                case 'aprovado':
                    return { text: 'Aprovado', dotColor: 'bg-green-400', textColor: 'text-green-700' };
                case 'recusado':
                    return { text: 'Recusado', dotColor: 'bg-red-400', textColor: 'text-red-700' };
                default:
                    return { text: 'Aguardando aprovação', dotColor: 'bg-yellow-400', textColor: 'text-yellow-700' };
            }
        }
        
        // Adicione esta nova função
        function createBudgetCardHTML(budget) {
            const statusInfo = getStatusInfo(budget.status);
            const formattedValue = (budget.totalFinalOrcamento || 0).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
            const creationDate = budget.createdAt?.toDate ? budget.createdAt.toDate().toLocaleDateString('pt-BR') : budget.dataOrcamento;

            return `
                <div class="flex flex-col space-y-3">
                    <div class="flex items-center space-x-2">
                        <span class="h-2 w-2 rounded-full ${statusInfo.dotColor}"></span>
                        <span class="text-xs font-medium ${statusInfo.textColor}">${statusInfo.text}</span>
                    </div>
                    <div>
                        <p class="font-semibold text-gray-800">${budget.clienteNome}</p>
                        <div class="text-xs text-gray-500 mt-1">
                            <span>Pedido n. ${budget.id.substring(0, 4).toUpperCase()}-${creationDate ? creationDate.substring(creationDate.length - 4) : ''}</span>
                            &bull;
                            <span>Criado em ${creationDate || 'N/A'}</span>
                        </div>
                    </div>
                    <div class="flex justify-between items-center text-sm pt-2 border-t border-gray-100">
                         <span class="text-gray-600">Valor:</span>
                         <span class="font-bold text-gray-800">${formattedValue}</span>
                    </div>
                </div>
             `;
        }

        // Substitua sua função renderSavedBudgets por esta
        function renderSavedBudgets(budgetsToRender) {
             const listContainer = document.getElementById('savedBudgetsList');
             const noMsg = document.getElementById('noSavedBudgetsMessage');
             if (!listContainer || !noMsg) return;
             
             listContainer.innerHTML = '';
             noMsg.style.display = budgetsToRender.length === 0 ? 'block' : 'none';

             budgetsToRender.forEach(budget => {
                 const budgetCard = document.createElement('div');
                 budgetCard.className = 'bg-white p-4 rounded-lg shadow-sm border border-gray-200 cursor-pointer hover:border-indigo-400 transition-colors duration-200';
                 budgetCard.dataset.budgetId = budget.id;
                 budgetCard.innerHTML = createBudgetCardHTML(budget);
                 listContainer.appendChild(budgetCard);
                 
                 budgetCard.addEventListener('click', () => {
                    // Chame sua função original para ver os detalhes
                    // Ex: showViewBudgetModal(budget);
                 });
             });
        }
        
        // Adicione esta nova função para renderizar a lista agrupada
        function renderGroupedBudgets() {
            const groupedContainer = document.getElementById('savedBudgetsGroupedList');
            if (!groupedContainer) return;

            groupedContainer.innerHTML = '';
            const budgetsByStatus = allSavedBudgets.reduce((acc, budget) => {
                const statusKey = getStatusInfo(budget.status).text;
                if (!acc[statusKey]) acc[statusKey] = [];
                acc[statusKey].push(budget);
                return acc;
            }, {});

            const statusOrder = ['Aguardando aprovação', 'Aprovado', 'Recusado'];
            statusOrder.forEach(status => {
                const budgetsInStatus = budgetsByStatus[status];
                if (budgetsInStatus && budgetsInStatus.length > 0) {
                    const statusInfo = getStatusInfo(status);
                    const groupTitle = document.createElement('h3');
                    groupTitle.className = "text-md font-bold text-gray-600 px-1 flex items-center";
                    groupTitle.innerHTML = `<span class="h-2.5 w-2.5 rounded-full ${statusInfo.dotColor} mr-2"></span> ${status}`;
                    groupedContainer.appendChild(groupTitle);

                    const listWrapper = document.createElement('div');
                    listWrapper.className = 'space-y-3';
                    
                    budgetsInStatus.forEach(budget => {
                        const budgetCard = document.createElement('div');
                        budgetCard.className = 'bg-white p-4 rounded-lg shadow-sm border border-gray-200 cursor-pointer hover:border-indigo-400';
                        budgetCard.dataset.budgetId = budget.id;
                        budgetCard.innerHTML = createBudgetCardHTML(budget);
                        listWrapper.appendChild(budgetCard);
                        
                        budgetCard.addEventListener('click', () => {
                           // Chame sua função original para ver os detalhes
                        });
                    });
                    groupedContainer.appendChild(listWrapper);
                }
            });
        }

        // Modifique sua função loadAndDisplaySavedBudgets
        function loadAndDisplaySavedBudgets() {
             const loadingMsg = document.getElementById('loadingSavedBudgetsMessage');
             if (!savedBudgetsCollectionRef || !loadingMsg) return;
             
             loadingMsg.style.display = 'block';
             document.getElementById('noSavedBudgetsMessage').style.display = 'none';

             unsubscribeBudgets = onSnapshot(savedBudgetsCollectionRef, (snapshot) => {
                 allSavedBudgets = [];
                 snapshot.forEach(doc => allSavedBudgets.push({ id: doc.id, ...doc.data() }));
                 allSavedBudgets.sort((a,b) => (b.createdAt?.toDate() || 0) - (a.createdAt?.toDate() || 0)); 
                 
                 // Renderiza a view que estiver ativa no momento
                 switchBudgetsView(currentBudgetsView);

                 loadingMsg.style.display = 'none';
             }, (error) => {
                 console.error("Erro ao carregar orçamentos:", error);
                 loadingMsg.style.display = 'none';
                 document.getElementById('noSavedBudgetsMessage').textContent = "Erro ao carregar dados.";
                 document.getElementById('noSavedBudgetsMessage').style.display = 'block';
             });
        }
        
        // Modifique sua função performSearchSavedBudgets
        function performSearchSavedBudgets() {
            if (!searchSavedBudgetsInput) return;
            const searchTerm = searchSavedBudgetsInput.value.toLowerCase().trim();
            
            // A busca funciona apenas na visão "Todos", que é o padrão
            if (currentBudgetsView !== 'all') {
                switchBudgetsView('all');
            }

            const filtered = allSavedBudgets.filter(b => 
                (b.clienteNome?.toLowerCase() || '').includes(searchTerm) ||
                (b.servicoDescricao?.toLowerCase() || '').includes(searchTerm)
            );
            renderSavedBudgets(filtered);
        }

    </script>
</body>
</html>