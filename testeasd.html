<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Serralheria Bom Preço - Gerenciador de Orçamentos</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #e5e7eb;
        }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }
        .card-hover:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .modal {
            display: none; position: fixed; z-index: 1000; left: 0; top: 0;
            width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6);
            align-items: center; justify-content: center; padding: 1rem;
        }
        .modal-content {
            background-color: #1f2937; color: #e5e7eb; margin: auto; padding: 25px;
            border: 1px solid #374151; width: 90%; max-width: 600px; 
            border-radius: 0.75rem; box-shadow: 0 10px 25px rgba(0,0,0,0.3);
        }
        .modal-header {
            padding-bottom: 1rem; border-bottom: 1px solid #374151; margin-bottom: 1.5rem;
            font-size: 1.25rem; font-weight: 600; color: #60a5fa;
        }
        .modal-footer {
            padding-top: 1rem; border-top: 1px solid #374151; margin-top: 1.5rem;
        }
        .logo-container { display: flex; flex-direction: column; align-items: center; margin-bottom: 1.5rem; }
        .logo-container img { max-width: 150px; margin-bottom: 0.75rem; border-radius: 0.5rem; background-color: white; padding: 5px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        
        .orcamento-total-item {
            display: flex;
            justify-content: space-between;
            align-items: center; 
            padding: 0.5rem 0;
            border-bottom: 1px solid #e5e7eb; 
        }
         .orcamento-total-item:last-child {
            border-bottom: none;
        }
        .orcamento-total-label {
            font-weight: 500; 
            color: #4b5563; 
        }
        .orcamento-total-value {
            font-weight: 600; 
            color: #1f2937; 
        }
        .orcamento-total-geral .orcamento-total-label,
        .orcamento-total-geral .orcamento-total-value {
            font-size: 1.25rem; 
            font-weight: 700; 
            color: #166534; 
        }
        .input-currency, .input-percent {
            width: 80px;
            padding: 0.25rem 0.5rem;
            border: 1px solid #d1d5db; 
            border-radius: 0.375rem; 
            text-align: right;
        }

        @media print {
            body > *:not(#printableArea) {
                display: none !important;
            }
            #printableArea {
                visibility: visible !important;
                display: block !important;
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                font-size: 12px;
                color: #000 !important;
            }
            #printableArea h1, #printableArea h2, #printableArea h3, #printableArea h4 { color: #000 !important; }
            #printableArea .print-header img { max-width: 100px; margin-bottom: 10px; }
            #printableArea table { width: 100%; border-collapse: collapse; margin-bottom: 15px; }
            #printableArea th, #printableArea td { border: 1px solid #ccc; padding: 6px; text-align: left; }
            #printableArea th { background-color: #f0f0f0; }
            #printableArea .print-summary-item { display: flex; justify-content: space-between; padding: 4px 0; font-size: 13px; }
            #printableArea .print-summary-item.total { font-weight: bold; font-size: 14px; border-top: 1px solid #000; padding-top: 8px; margin-top: 8px; }
            .no-print { display: none !important; }
        }
        #printableArea { display: none; }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center justify-center p-4">

    <!-- Tela de Login -->
    <div id="login-screen" class="bg-white shadow-2xl rounded-xl p-6 md:p-10 w-full max-w-md text-slate-800 text-center hidden">
        <div class="logo-container">
            <img src="" alt="Logo da Serralheria Bom Preço" id="loginCompanyLogo">
            <h1 id="loginMainCompanyName" class="text-3xl md:text-4xl font-bold text-sky-600"></h1>
        </div>
        <p class="text-slate-600 mb-8">Acesse o sistema para gerenciar seus orçamentos.</p>
        <button id="loginWithGoogle" class="w-full flex items-center justify-center bg-white border border-slate-300 text-slate-700 font-semibold py-3 px-6 rounded-lg transition duration-300 ease-in-out hover:bg-slate-100 focus:outline-none focus:ring-2 focus:ring-sky-500 shadow-md">
            <svg class="w-5 h-5 mr-3" viewBox="0 0 48 48" width="48px" height="48px"><path fill="#fbc02d" d="M43.611,20.083H42V20H24v8h11.303c-1.649,4.657-6.08,8-11.303,8c-6.627,0-12-5.373-12-12	s5.373-12,12-12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C12.955,4,4,12.955,4,24s8.955,20,20,20	s20-8.955,20-20C44,22.659,43.862,21.35,43.611,20.083z"></path><path fill="#e53935" d="M6.306,14.691l6.571,4.819C14.655,15.108,18.961,12,24,12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657	C34.046,6.053,29.268,4,24,4C16.318,4,9.656,8.337,6.306,14.691z"></path><path fill="#4caf50" d="M24,44c5.166,0,9.86-1.977,13.409-5.192l-6.19-5.238C29.211,35.091,26.715,36,24,36	c-5.222,0-9.619-3.317-11.283-7.946l-6.522,5.025C9.505,39.556,16.227,44,24,44z"></path><path fill="#1565c0" d="M43.611,20.083H42V20H24v8h11.303c-0.792,2.237-2.231,4.166-4.087,5.574l6.19,5.238	C42.022,35.244,44,30.038,44,24C44,22.659,43.862,21.35,43.611,20.083z"></path></svg>
            Entrar com Google
        </button>
        <p id="authFeedback" class="mt-4 text-sm text-red-600"></p>
    </div>

    <!-- Conteúdo Principal do App (oculto até o login) -->
    <div id="main-content" class="hidden bg-white shadow-2xl rounded-xl p-6 md:p-10 w-full max-w-3xl text-slate-800 no-print">
        <header class="mb-8 text-center">
            <div class="logo-container">
                <img src="" alt="Logo da Serralheria Bom Preço" id="companyLogo">
                <h1 id="mainCompanyName" class="text-3xl md:text-4xl font-bold text-sky-600"></h1>
            </div>
            <p class="text-slate-600 mt-2">Gerenciador de Materiais e Orçamentos</p>
            <div class="mt-4 text-xs text-slate-500">
                <p>Utilizador: <span id="userEmailDisplay" class="font-mono text-slate-700"></span></p>
                <p class="mt-1">ID do Projeto: <span id="appIdDisplay" class="font-mono text-slate-700"></span></p>
                <button id="logoutButton" class="mt-2 text-sm text-red-600 hover:underline">Sair</button>
            </div>
        </header>

        <!-- Seção de Orçamento -->
        <section id="orcamento-section" class="mb-10">
            <h2 id="orcamentoFormTitle" class="text-2xl font-semibold text-sky-600 mb-6 text-center">Criar Novo Orçamento</h2>
            <div class="mb-4 p-4 border border-slate-200 rounded-lg bg-slate-50 space-y-4">
                <input type="hidden" id="editingBudgetId"> 
                <div>
                    <label for="orcamentoClienteNome" class="block text-sm font-medium text-sky-700 mb-1">Nome do Cliente</label>
                    <input type="text" id="orcamentoClienteNome" class="w-full px-4 py-3 bg-white border border-slate-300 rounded-lg text-slate-900 focus:ring-2 focus:ring-sky-500 outline-none" placeholder="Digite o nome do cliente">
                </div>
                <div>
                    <label for="orcamentoServicoDescricao" class="block text-sm font-medium text-sky-700 mb-1">Descrição do Serviço/Orçamento</label>
                    <textarea id="orcamentoServicoDescricao" rows="3" class="w-full px-4 py-3 bg-white border border-slate-300 rounded-lg text-slate-900 focus:ring-2 focus:ring-sky-500 outline-none" placeholder="Ex: Fabricação e instalação de grade..."></textarea>
                </div>
            </div>
            <div class="mb-6 p-4 border border-slate-200 rounded-lg bg-slate-50">
                <h3 class="text-lg font-semibold text-sky-700 mb-3">Adicionar Item ao Orçamento</h3>
                <div class="grid grid-cols-1 md:grid-cols-6 gap-4 items-end">
                    <div class="md:col-span-3">
                        <label for="searchMaterialToAdd" class="block text-sm font-medium text-sky-700 mb-1">Pesquisar Material</label>
                        <input type="text" id="searchMaterialToAdd" list="materialDatalist" class="w-full px-4 py-3 bg-white border border-slate-300 rounded-lg text-slate-900 focus:ring-2 focus:ring-sky-500 outline-none" placeholder="Digite para pesquisar um material...">
                        <datalist id="materialDatalist"></datalist>
                    </div>
                    <div class="md:col-span-2">
                        <label for="quantidadeMaterialOrcamento" class="block text-sm font-medium text-sky-700 mb-1">Quantidade</label>
                        <input type="number" id="quantidadeMaterialOrcamento" min="0.01" step="any" value="1" class="w-full px-4 py-3 bg-white border border-slate-300 rounded-lg text-slate-900 focus:ring-2 focus:ring-sky-500 outline-none">
                    </div>
                    <button id="btnAdicionarMaterialOrcamento" class="md:col-span-1 w-full bg-green-500 hover:bg-green-600 text-white font-semibold py-3 px-4 rounded-lg transition">Adicionar</button>
                </div>
                <div id="orcamentoFormFeedback" class="mt-3 text-sm"></div>
            </div>
            <div class="mt-8">
                <h3 class="text-xl font-semibold text-sky-700 mb-4">Itens do Orçamento Atual</h3>
                <div id="orcamentoItensList" class="space-y-3 mb-4">
                    <p id="orcamentoVazioMsg" class="text-slate-500 text-center p-4 border-2 border-dashed border-slate-300 rounded-md">Nenhum item.</p>
                </div>
                <div class="mt-6 p-4 bg-slate-100 rounded-lg shadow">
                    <h4 class="text-lg font-semibold text-sky-700 mb-3 text-center">Resumo do Orçamento</h4>
                    <div class="space-y-2">
                        <div class="orcamento-total-item"><span class="orcamento-total-label">Total Materiais:</span><span class="orcamento-total-value">R$ <span id="orcamentoTotalMateriais">0.00</span></span></div>
                        <div class="orcamento-total-item">
                            <span class="orcamento-total-label">Mão de Obra (<input type="number" id="percentualMaoDeObra" value="120" min="0" class="input-percent"> %):</span>
                            <span class="orcamento-total-value">R$ <span id="orcamentoValorMaoDeObra">0.00</span></span>
                        </div>
                        <div class="orcamento-total-item"><span class="orcamento-total-label">Subtotal (Materiais + M.O.):</span><span class="orcamento-total-value">R$ <span id="orcamentoSubtotalComMaoDeObra">0.00</span></span></div>
                        <div class="orcamento-total-item"><span class="orcamento-total-label">ISSQN (2% sobre Subtotal):</span><span class="orcamento-total-value">R$ <span id="orcamentoValorISSQN">0.00</span></span></div>
                        <div class="orcamento-total-item">
                            <span class="orcamento-total-label">Frete:</span>
                            <div class="flex items-center">
                                <span class="mr-1">R$</span>
                                <input type="number" id="valorFrete" value="0" min="0" step="0.01" class="input-currency">
                            </div>
                        </div>
                        <div class="orcamento-total-item orcamento-total-geral pt-3 mt-2 border-t-2 border-sky-500"><span class="orcamento-total-label">TOTAL DO ORÇAMENTO:</span><span class="orcamento-total-value">R$ <span id="orcamentoTotalFinal">0.00</span></span></div>
                    </div>
                </div>
                <div class="mt-8 flex flex-col sm:flex-row justify-center items-center space-y-4 sm:space-y-0 sm:space-x-4">
                    <button id="btnSalvarOrcamento" class="w-full sm:w-auto bg-teal-600 hover:bg-teal-700 text-white font-semibold py-3 px-8 rounded-lg transition">Salvar Orçamento</button>
                    <button id="btnImprimirOrcamento" class="w-full sm:w-auto bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-8 rounded-lg transition">Imprimir / Gerar PDF</button>
                </div>
                <div id="cancelEditContainer" class="mt-4 text-center" style="display: none;">
                    <button id="btnCancelarEdicao" class="text-sm text-red-600 hover:underline">Cancelar Edição</button>
                </div>
                 <div id="salvarOrcamentoFeedback" class="mt-4 text-sm text-center"></div>
            </div>
        </section>

        <hr class="border-slate-300 my-10">
        
        <section id="saved-budgets-section" class="mb-10">
            <h2 class="text-2xl font-semibold text-sky-600 mb-6 text-center">Orçamentos Salvos</h2>
            <div class="mb-6 flex items-center space-x-2">
                <div class="flex-grow">
                    <label for="searchSavedBudgets" class="block text-sm font-medium text-sky-700 mb-1">Pesquisar Orçamentos</label>
                    <input type="text" id="searchSavedBudgets" class="w-full px-4 py-3 bg-slate-50 border border-slate-300 rounded-lg text-slate-900 focus:ring-2 focus:ring-sky-500 outline-none" placeholder="Nome do cliente, descrição ou item...">
                </div>
                <button id="btnSearchSavedBudgets" class="self-end px-5 py-3 bg-sky-500 text-white rounded-lg hover:bg-sky-600 focus:outline-none focus:ring-2 focus:ring-sky-500">Pesquisar</button>
            </div>
            <div id="savedBudgetsList" class="space-y-4" style="display: none;"></div>
            <p id="loadingSavedBudgetsMessage" class="text-slate-500 text-center">Carregando orçamentos salvos...</p>
            <p id="savedBudgetsInfoMessage" class="text-slate-500 text-center p-4 border-2 border-dashed border-slate-300 rounded-md" style="display: none;">Digite e clique em "Pesquisar" para ver os orçamentos salvos.</p>
            <p id="noSavedBudgetsMessage" class="text-slate-500 text-center" style="display: none;">Nenhum orçamento salvo encontrado ou correspondente à pesquisa.</p>
        </section>

        <hr class="border-slate-300 my-10">

        <section id="form-section" class="mb-8">
            <h2 class="text-xl font-semibold text-sky-700 mb-4 text-center">Cadastrar Novo Material no Catálogo</h2>
            <form id="addMaterialForm" class="space-y-6">
                <div>
                    <label for="materialName" class="block text-sm font-medium text-sky-700 mb-1">Nome</label>
                    <input type="text" id="materialName" required class="w-full px-4 py-3 bg-slate-50 border border-slate-300 rounded-lg text-slate-900 focus:ring-2 focus:ring-sky-500 outline-none" placeholder="Ex: Barra de Ferro Chato 1/8">
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="materialUnit" class="block text-sm font-medium text-sky-700 mb-1">Unidade</label>
                        <input type="text" id="materialUnit" required class="w-full px-4 py-3 bg-slate-50 border border-slate-300 rounded-lg text-slate-900 focus:ring-2 focus:ring-sky-500 outline-none" placeholder="Ex: Metro, KG, Unidade">
                    </div>
                    <div>
                        <label for="materialPrice" class="block text-sm font-medium text-sky-700 mb-1">Preço (R$)</label>
                        <input type="number" id="materialPrice" step="0.01" required class="w-full px-4 py-3 bg-slate-50 border border-slate-300 rounded-lg text-slate-900 focus:ring-2 focus:ring-sky-500 outline-none" placeholder="Ex: 25.50">
                    </div>
                </div>
                <button type="submit" class="w-full bg-sky-600 hover:bg-sky-700 text-white font-semibold py-3 px-6 rounded-lg transition">Adicionar ao Catálogo</button>
            </form>
            <div id="formFeedback" class="mt-4 text-sm"></div>
        </section>

        <hr class="border-slate-300 my-10">

        <section id="list-section" class="mb-10">
             <div class="mb-6 flex items-center space-x-2">
                <div class="flex-grow">
                    <label for="searchMaterials" class="block text-sm font-medium text-sky-700 mb-1">Pesquisar Catálogo</label>
                    <input type="text" id="searchMaterials" class="w-full px-4 py-3 bg-slate-50 border border-slate-300 rounded-lg text-slate-900 focus:ring-2 focus:ring-sky-500 outline-none" placeholder="Nome do material...">
                </div>
                <button id="btnSearchMaterials" class="self-end px-5 py-3 bg-sky-500 text-white rounded-lg hover:bg-sky-600 focus:outline-none focus:ring-2 focus:ring-sky-500">Pesquisar</button>
            </div>
            <h2 class="text-2xl font-semibold text-sky-600 mb-6 text-center">Catálogo de Materiais</h2>
            <div id="materialsList" class="space-y-4" style="display: none;"></div>
            <p id="loadingMessage" class="text-slate-500 text-center">Carregando catálogo...</p>
            <p id="catalogInfoMessage" class="text-slate-500 text-center p-4 border-2 border-dashed border-slate-300 rounded-md" style="display: none;">Digite e clique em "Pesquisar" para ver.</p>
            <p id="noResultsMessage" class="text-slate-500 text-center" style="display: none;">Nenhum material encontrado.</p>
        </section>
    </div>

    <!-- Área de Impressão -->
     <div id="printableArea">
        </div>

    <!-- Modais -->
    <div id="confirmDeleteMaterialModal" class="modal no-print">
        </div>
    <div id="confirmDeleteBudgetModal" class="modal no-print">
        </div>
    <div id="editMaterialModal" class="modal no-print">
         </div>
    <div id="viewBudgetModal" class="modal no-print"> 
        </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, deleteDoc, updateDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- CÓDIGO JAVASCRIPT COMPLETO ABAIXO ---
        // (Todo o código JS que já temos continua aqui)
        
    </script>
</body>
</html>